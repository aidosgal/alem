<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alem - –¢–µ—Å—Ç —á–∞—Ç–∞ –∞–ø–ø–ª–∏–∫–∞–Ω—Ç–∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'JetBrains Mono', monospace;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-4xl w-full bg-white rounded-lg shadow-lg p-8">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900 mb-2">Alem Chat Test</h1>
                <p class="text-gray-600">–ü—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–∞—Ç–∞ (—Å—Ç–æ—Ä–æ–Ω–∞ –∞–ø–ø–ª–∏–∫–∞–Ω—Ç–∞)</p>
            </div>

            <!-- Connection Info -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <h3 class="font-semibold text-blue-900 mb-2">üì° WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</h3>
                <p class="text-sm text-blue-700 mb-2">
                    <strong>URL:</strong> <code class="bg-blue-100 px-2 py-1 rounded">ws://localhost:8080</code>
                </p>
                <p class="text-sm text-blue-700 mb-2">
                    <strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="connection-status" class="font-medium">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
                </p>
                <div class="flex gap-2 mt-2">
                    <button onclick="connectWebSocket()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                        –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ WebSocket
                    </button>
                    <button onclick="showCreateChatModal()" 
                            class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
                        + –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç
                    </button>
                </div>
            </div>

            <!-- Chat Interface -->
            <div class="border border-gray-200 rounded-lg overflow-hidden">
                <!-- Messages -->
                <div id="messages" class="h-96 overflow-y-auto p-4 bg-gray-50 space-y-3">
                    <div class="text-center text-gray-500 text-sm">
                        –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å
                    </div>
                </div>

                <!-- Input -->
                <div class="bg-white border-t border-gray-200 p-4">
                    <form id="message-form" class="flex gap-2">
                        <input type="text" 
                               id="message-input" 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                               class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <button type="submit" 
                                class="px-6 py-2 bg-[#EFFE6D] text-gray-900 font-medium rounded-lg hover:bg-[#EFFE6D]/90 transition-colors">
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                        </button>
                    </form>
                </div>
            </div>

            <!-- Test Controls -->
            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Chat ID Input -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Chat ID (UUID –∏–∑ –±–∞–∑—ã)
                    </label>
                    <div class="flex gap-2">
                        <input type="text" 
                               id="chat-id" 
                               placeholder="01234567-89ab-cdef-0123-456789abcdef"
                               class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <button onclick="loadChatsList()" 
                                class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors whitespace-nowrap">
                            üìã –°–ø–∏—Å–æ–∫
                        </button>
                    </div>
                </div>

                <!-- API Endpoint -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        API Endpoint
                    </label>
                    <input type="text" 
                           id="api-endpoint" 
                           value="http://localhost:8000"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>

            <!-- Instructions -->
            <div class="mt-6 bg-gray-50 border border-gray-300 rounded-lg p-4">
                <h3 class="font-semibold text-gray-900 mb-2">üìù –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é:</h3>
                <ol class="list-decimal list-inside text-sm text-gray-700 space-y-1">
                    <li>–ó–∞–ø—É—Å—Ç–∏—Ç–µ Laravel: <code class="bg-gray-200 px-2 py-0.5 rounded">php artisan serve</code></li>
                    <li>–ó–∞–ø—É—Å—Ç–∏—Ç–µ Reverb: <code class="bg-gray-200 px-2 py-0.5 rounded">php artisan reverb:start</code></li>
                    <li><strong>–ù–æ–≤–æ–µ!</strong> –ù–∞–∂–º–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç" —á—Ç–æ–±—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —á–∞—Ç</li>
                    <li>–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ "üìã –°–ø–∏—Å–æ–∫" —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —á–∞—Ç—ã</li>
                    <li>–í—Å—Ç–∞–≤—å—Ç–µ Chat ID –∏ –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ WebSocket"</li>
                    <li>–û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</li>
                    <li>–û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –æ–±–µ–∏—Ö —Å—Ç–æ—Ä–æ–Ω!</li>
                </ol>
            </div>

            <!-- Debug Log -->
            <details class="mt-4">
                <summary class="cursor-pointer text-sm font-medium text-gray-700 hover:text-gray-900">
                    üêõ Debug Log (–∫–æ–Ω—Å–æ–ª—å)
                </summary>
                <div id="debug-log" class="mt-2 p-4 bg-gray-900 text-green-400 rounded-lg font-mono text-xs max-h-60 overflow-y-auto">
                    <div>Waiting for events...</div>
                </div>
            </details>
        </div>
    </div>

    <!-- Create Chat Modal -->
    <div id="create-chat-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white rounded-lg max-w-md w-full mx-4 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-900">–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —á–∞—Ç</h3>
                <button onclick="closeCreateChatModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <form id="create-chat-form" onsubmit="createTestChat(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        –ò–º—è –∞–ø–ø–ª–∏–∫–∞–Ω—Ç–∞
                    </label>
                    <input type="text" 
                           id="applicant-name" 
                           value="Test Applicant"
                           required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Email –∞–ø–ø–ª–∏–∫–∞–Ω—Ç–∞
                    </label>
                    <input type="email" 
                           id="applicant-email" 
                           value="test@example.com"
                           required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <div id="create-chat-error" class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700 hidden"></div>
                <div id="create-chat-success" class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg text-sm text-green-700 hidden"></div>

                <div class="flex gap-3 justify-end">
                    <button type="button" 
                            onclick="closeCreateChatModal()"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" 
                            id="create-chat-btn"
                            class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700">
                        –°–æ–∑–¥–∞—Ç—å —á–∞—Ç
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Chats List Modal -->
    <div id="chats-list-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white rounded-lg max-w-2xl w-full mx-4 p-6 max-h-[80vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-900">–°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤</h3>
                <button onclick="closeChatsListModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <div id="chats-list-loading" class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="text-sm text-gray-600 mt-2">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>

            <div id="chats-list-content" class="hidden">
                <div id="chats-list-items" class="space-y-2">
                    <!-- Chats will be inserted here -->
                </div>
            </div>

            <div id="chats-list-error" class="hidden p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700"></div>
        </div>
    </div>

    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <script>
        let pusher = null;
        let channel = null;
        let currentChatId = null;
        let currentApplicantId = null;
        const debugLog = document.getElementById('debug-log');
        const messagesContainer = document.getElementById('messages');
        const statusEl = document.getElementById('connection-status');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');

        // Utility function
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-blue-400';
            debugLog.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function updateStatus(status, color) {
            statusEl.textContent = status;
            statusEl.className = `font-medium ${color}`;
        }

        function connectWebSocket() {
            const chatId = document.getElementById('chat-id').value.trim();
            if (!chatId) {
                alert('–í–≤–µ–¥–∏—Ç–µ Chat ID!');
                return;
            }

            // Store chat ID globally
            currentChatId = chatId;

            log('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket...', 'info');
            
            try {
                // Initialize Pusher (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ –∂–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á—Ç–æ –∏ –≤ Laravel)
                pusher = new Pusher('rbgxcm7cdjr0ey4apana', {
                    wsHost: 'localhost',
                    wsPort: 8080,
                    forceTLS: false,
                    disableStats: true,
                    enabledTransports: ['ws', 'wss'],
                    cluster: 'mt1' // Required by Pusher but ignored by Reverb
                });

                // Connection events
                pusher.connection.bind('connected', () => {
                    log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω!', 'success');
                    updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'text-green-600');
                    
                    // Load chat info and messages
                    loadChatInfo();
                });

                pusher.connection.bind('disconnected', () => {
                    log('‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω', 'error');
                    updateStatus('–û—Ç–∫–ª—é—á–µ–Ω–æ', 'text-red-600');
                });

                pusher.connection.bind('error', (err) => {
                    log(`‚ùå –û—à–∏–±–∫–∞: ${JSON.stringify(err)}`, 'error');
                    updateStatus('–û—à–∏–±–∫–∞', 'text-red-600');
                });

                // Subscribe to private chat channel
                // Note: –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ /broadcasting/auth
                // –î–ª—è —Ç–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º public channel –∏–ª–∏ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
                log(`–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª: private-chat.${chatId}`, 'info');
                
                // –î–ª—è —Ç–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º public channel (–∏–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ private –≤ production)
                channel = pusher.subscribe(`chat.${chatId}`);
                
                channel.bind('pusher:subscription_succeeded', () => {
                    log('‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª —É—Å–ø–µ—à–Ω–∞!', 'success');
                    addSystemMessage('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —á–∞—Ç—É. –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π...');
                });

                channel.bind('pusher:subscription_error', (err) => {
                    log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏: ${JSON.stringify(err)}`, 'error');
                    addSystemMessage('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —á–∞—Ç—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Chat ID.');
                });

                // Listen for messages
                channel.bind('message.sent', (data) => {
                    log(`üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: ${JSON.stringify(data)}`, 'success');
                    addMessage(data);
                });

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message);
            }
        }

        function addMessage(data) {
            // Handle both WebSocket format and API format
            const sender = data.sender || {
                type: data.sender_applicant_id ? 'applicant' : 'manager',
                name: data.sender_applicant_id 
                    ? (data.sender_applicant?.user?.name || 'Applicant')
                    : (data.sender_manager?.user?.name || 'Manager')
            };
            
            const isOwn = sender.type === 'applicant';
            const msgDiv = document.createElement('div');
            msgDiv.className = `flex ${isOwn ? 'justify-end' : 'justify-start'}`;
            
            const time = new Date(data.created_at).toLocaleTimeString('ru-RU', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            let content = '';
            if (data.type === 'image') {
                content = `<img src="${data.file_path}" class="max-w-xs rounded-lg mb-2" />`;
            } else if (data.type === 'file') {
                content = `<div class="p-2 bg-gray-100 rounded mb-2">üìé ${data.file_name}</div>`;
            } else if (data.type === 'order') {
                content = `<div class="p-2 bg-blue-100 rounded mb-2">üìã –ó–∞–∫–∞–∑: ${data.metadata?.order_title || 'Order'}</div>`;
            }
            
            if (data.content) {
                content += `<p class="text-sm">${escapeHtml(data.content)}</p>`;
            } else if (!content) {
                // If no content and no file, show empty message indicator
                content = `<p class="text-sm text-gray-400 italic">[–ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]</p>`;
            }
            
            msgDiv.innerHTML = `
                <div class="max-w-md ${isOwn ? 'bg-[#EFFE6D]' : 'bg-white'} rounded-lg p-3 shadow">
                    ${!isOwn ? `<p class="text-xs font-medium text-gray-600 mb-1">${escapeHtml(sender.name)}</p>` : ''}
                    ${content}
                    <p class="text-xs text-gray-500 mt-1">${time}</p>
                </div>
            `;
            
            messagesContainer.appendChild(msgDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addSystemMessage(text) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'text-center';
            msgDiv.innerHTML = `<p class="text-xs text-gray-500 italic">${escapeHtml(text)}</p>`;
            messagesContainer.appendChild(msgDiv);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Create Chat Modal functions
        function showCreateChatModal() {
            document.getElementById('create-chat-modal').classList.remove('hidden');
            document.getElementById('create-chat-modal').classList.add('flex');
            // Generate random email for testing
            const randomEmail = 'test_' + Math.random().toString(36).substring(7) + '@example.com';
            document.getElementById('applicant-email').value = randomEmail;
        }

        function closeCreateChatModal() {
            document.getElementById('create-chat-modal').classList.remove('flex');
            document.getElementById('create-chat-modal').classList.add('hidden');
            document.getElementById('create-chat-error').classList.add('hidden');
            document.getElementById('create-chat-success').classList.add('hidden');
        }

        async function createTestChat(event) {
            event.preventDefault();
            
            const apiEndpoint = document.getElementById('api-endpoint').value;
            const name = document.getElementById('applicant-name').value;
            const email = document.getElementById('applicant-email').value;
            const btn = document.getElementById('create-chat-btn');
            const errorEl = document.getElementById('create-chat-error');
            const successEl = document.getElementById('create-chat-success');
            
            errorEl.classList.add('hidden');
            successEl.classList.add('hidden');
            btn.disabled = true;
            btn.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ...';
            
            log(`–°–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞ –¥–ª—è ${name} (${email})...`, 'info');
            
            try {
                // Use Tinker API endpoint (we'll create this)
                const response = await fetch(`${apiEndpoint}/api/test/create-chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        email: email
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    log(`‚úÖ –ß–∞—Ç —Å–æ–∑–¥–∞–Ω! ID: ${data.chat_id}, Applicant ID: ${data.applicant_id}`, 'success');
                    successEl.textContent = `–ß–∞—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω! ID: ${data.chat_id}`;
                    successEl.classList.remove('hidden');
                    
                    // Auto-fill chat ID and store applicant ID
                    document.getElementById('chat-id').value = data.chat_id;
                    currentChatId = data.chat_id;
                    currentApplicantId = data.applicant_id;
                    
                    setTimeout(() => {
                        closeCreateChatModal();
                        addSystemMessage(`–ß–∞—Ç —Å–æ–∑–¥–∞–Ω! ID: ${data.chat_id}. –¢–µ–ø–µ—Ä—å –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ WebSocket.`);
                    }, 2000);
                } else {
                    throw new Error(data.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞');
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                errorEl.textContent = error.message;
                errorEl.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.textContent = '–°–æ–∑–¥–∞—Ç—å —á–∞—Ç';
            }
        }

        // Chats List Modal functions
        function showChatsListModal() {
            document.getElementById('chats-list-modal').classList.remove('hidden');
            document.getElementById('chats-list-modal').classList.add('flex');
        }

        function closeChatsListModal() {
            document.getElementById('chats-list-modal').classList.remove('flex');
            document.getElementById('chats-list-modal').classList.add('hidden');
        }

        async function loadChatsList() {
            showChatsListModal();
            
            const apiEndpoint = document.getElementById('api-endpoint').value;
            const loadingEl = document.getElementById('chats-list-loading');
            const contentEl = document.getElementById('chats-list-content');
            const errorEl = document.getElementById('chats-list-error');
            const itemsEl = document.getElementById('chats-list-items');
            
            loadingEl.classList.remove('hidden');
            contentEl.classList.add('hidden');
            errorEl.classList.add('hidden');
            
            log('–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤...', 'info');
            
            try {
                const response = await fetch(`${apiEndpoint}/api/test/chats`, {
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.chats.length} —á–∞—Ç–æ–≤`, 'success');
                    
                    if (data.chats.length === 0) {
                        itemsEl.innerHTML = '<p class="text-center text-gray-500 py-4">–ß–∞—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π!</p>';
                    } else {
                        itemsEl.innerHTML = data.chats.map(chat => `
                            <div class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors"
                                 onclick="selectChat('${chat.id}')">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="font-medium text-gray-900">${escapeHtml(chat.applicant_name)}</p>
                                        <p class="text-sm text-gray-600">${escapeHtml(chat.organization_name)}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-xs text-gray-500 font-mono">${chat.id.substring(0, 8)}...</p>
                                        <p class="text-xs text-gray-400">${chat.messages_count} —Å–æ–æ–±—â–µ–Ω–∏–π</p>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    }
                    
                    loadingEl.classList.add('hidden');
                    contentEl.classList.remove('hidden');
                } else {
                    throw new Error(data.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤');
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                errorEl.textContent = error.message;
                errorEl.classList.remove('hidden');
                loadingEl.classList.add('hidden');
            }
        }

        function selectChat(chatId) {
            document.getElementById('chat-id').value = chatId;
            closeChatsListModal();
            addSystemMessage(`–ß–∞—Ç –≤—ã–±—Ä–∞–Ω: ${chatId}. –¢–µ–ø–µ—Ä—å –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ WebSocket.`);
            log(`–í—ã–±—Ä–∞–Ω —á–∞—Ç: ${chatId}`, 'info');
        }

        // Handle message form submission
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const content = messageInput.value.trim();
            
            if (!currentChatId || !currentApplicantId) {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ WebSocket!');
                return;
            }
            
            const apiEndpoint = document.getElementById('api-endpoint').value;
            
            log(`–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: "${content}"`, 'info');
            
            try {
                const response = await fetch(`${apiEndpoint}/api/applicant/chat/${currentChatId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify({
                        content: content,
                        applicant_id: currentApplicantId
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    log(`‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!`, 'success');
                    messageInput.value = '';
                    // Message will appear via WebSocket broadcast
                } else {
                    throw new Error(data.message || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${error.message}`, 'error');
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message);
            }
        });

        // Load initial messages when connecting
        async function loadInitialMessages() {
            if (!currentChatId) return;
            
            const apiEndpoint = document.getElementById('api-endpoint').value;
            
            log('–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π...', 'info');
            
            try {
                const response = await fetch(`${apiEndpoint}/api/applicant/chat/${currentChatId}/messages`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.messages.length} —Å–æ–æ–±—â–µ–Ω–∏–π`, 'success');
                    messagesContainer.innerHTML = ''; // Clear
                    data.messages.forEach(msg => addMessage(msg));
                } else {
                    throw new Error(data.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π: ${error.message}`, 'error');
            }
        }

        // Load chat info (get applicant_id from API)
        async function loadChatInfo() {
            if (!currentChatId) return;
            
            const apiEndpoint = document.getElementById('api-endpoint').value;
            
            try {
                const response = await fetch(`${apiEndpoint}/api/test/chats`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const chat = data.chats.find(c => c.id === currentChatId);
                    if (chat && chat.applicant_id) {
                        currentApplicantId = chat.applicant_id;
                        log(`‚úÖ Applicant ID –ø–æ–ª—É—á–µ–Ω: ${currentApplicantId}`, 'success');
                    }
                }
                
                // Load messages after getting chat info
                await loadInitialMessages();
            } catch (error) {
                log(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —á–∞—Ç–µ: ${error.message}`, 'error');
                // Try loading messages anyway
                await loadInitialMessages();
            }
        }

        // Initial message
        addSystemMessage('–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —á–∞—Ç –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π, –∑–∞—Ç–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ WebSocket');
    </script>
</body>
</html>
